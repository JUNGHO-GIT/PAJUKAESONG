ServerRoot "/usr/local/apache2"
Listen 80
Listen 443
ServerAdmin root@104.196.212.101
AddDefaultCharset UTF-8
EnableSendfile on

# 모듈 로드
LoadModule deflate_module modules/mod_deflate.so
LoadModule expires_module modules/mod_expires.so
LoadModule http2_module modules/mod_http2.so
LoadModule proxy_module modules/mod_proxy.so
LoadModule proxy_http_module modules/mod_proxy_http.so
LoadModule rewrite_module modules/mod_rewrite.so
LoadModule headers_module modules/mod_headers.so
LoadModule unixd_module modules/mod_unixd.so
LoadModule dir_module modules/mod_dir.so
LoadModule authz_core_module modules/mod_authz_core.so
LoadModule mime_module modules/mod_mime.so
LoadModule alias_module modules/mod_alias.so
LoadModule log_config_module modules/mod_log_config.so
LoadModule filter_module modules/mod_filter.so
# ssl 활성화 될때만 설정
LoadModule ssl_module modules/mod_ssl.so

# KeepAlive 설정 최적화
# KeepAlive On
# MaxKeepAliveRequests 100
# KeepAliveTimeout 5

# PID 파일 위치
PidFile "logs/httpd.pid"

# 사용자, 그룹 설정
User apache
Group apache

# 로그파일
ErrorLog "logs/error_log"
LogLevel warn

<VirtualHost *:80>
  ServerName junghomun.com
  ServerAlias www.junghomun.com
  DocumentRoot /var/www/html/build

  <Directory /var/www/html/build>
    Options -Indexes +FollowSymLinks
    DirectoryIndex index.html
    AllowOverride All
    Require all granted
    FallbackResource /index.html
  </Directory>

  <IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/text text/html text/plain text/xml text/css application/x-javascript application/javascript
  </IfModule>

  <IfModule mod_expires.c>
    ExpiresActive On
    ExpiresByType image/jpg "access plus 1 year"
    ExpiresByType image/jpeg "access plus 1 year"
    ExpiresByType image/gif "access plus 1 year"
    ExpiresByType image/png "access plus 1 year"
    ExpiresByType image/webp "access plus 1 year"
    ExpiresByType text/css "access plus 1 week"
    ExpiresByType text/html "access plus 600 seconds"
    ExpiresByType application/javascript "access plus 1 week"
    ExpiresByType application/x-javascript "access plus 1 week"
  </IfModule>

  <IfModule http2_module>
    Protocols h2 h2c http/1.1
  </IfModule>

  ProxyRequests Off
  ProxyPreserveHost On

  <Proxy *>
    Require all granted
  </Proxy>

  RewriteEngine on
  RewriteCond %{SERVER_NAME} =junghomun.com [OR]
  RewriteCond %{SERVER_NAME} =www.junghomun.com
  RewriteRule ^ https://%{SERVER_NAME}%{REQUEST_URI} [END,NE,R=permanent]
</VirtualHost>

<VirtualHost *:443>
  ServerName junghomun.com
  ServerAlias www.junghomun.com
  SSLEngine on
  DocumentRoot /var/www/html/build

  # Including recommended SSL configurations from Let's Encrypt
  Include /etc/letsencrypt/options-ssl-apache.conf

  # SSL certificate files
  SSLCertificateFile /etc/letsencrypt/live/www.junghomun.com/cert.pem
  SSLCertificateKeyFile /etc/letsencrypt/live/www.junghomun.com/privkey.pem
  SSLCertificateChainFile /etc/letsencrypt/live/www.junghomun.com/chain.pem

  ErrorLog logs/error_log
  CustomLog logs/access_log combined

  <Directory /var/www/html/build>
    Options -Indexes +FollowSymLinks
    DirectoryIndex index.html
    AllowOverride All
    Require all granted
    FallbackResource /index.html
  </Directory>

  <Proxy *>
    Require all granted
  </Proxy>

  # Proxy settings to redirect API calls to a backend server on localhost
  ProxyPass /api http://127.0.0.1:4000/api
  ProxyPassReverse /api http://127.0.0.1:4000/api

</VirtualHost>

<IfModule dir_module>
  DirectoryIndex index.html
</IfModule>

<IfModule log_config_module>
  LogFormat "%h %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\"" combined
  LogFormat "%h %l %u %t \"%r\" %>s %b" common
  <IfModule logio_module>
    LogFormat "%h %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\" %I %O" combinedio
  </IfModule>
  CustomLog "logs/access_log" combined
</IfModule>

<IfModule alias_module>
  ScriptAlias /cgi-bin/ "/var/www/cgi-bin/"
</IfModule>

<IfModule mime_module>
  AddType text/html .shtml
  AddOutputFilter INCLUDES .shtml
</IfModule>

<Directory "/var/www/html/build">
  Options -Indexes +FollowSymLinks
  AllowOverride All
  Require all granted
</Directory>

<Directory "/var/www/cgi-bin">
  AllowOverride None
  Options None
  Require all granted
</Directory>

<Directory />
  Options FollowSymLinks
  AllowOverride All
  Require all granted
</Directory>
